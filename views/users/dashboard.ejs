<% layout('layouts/boilerplate') %>
<% pageTitle = "Dashboard" %>

<%
/* ----------------------------
   Extract latest report safely
----------------------------- */
const _latest = latest || null;

/* Hypertension → Heart Rate mapping */
function deriveHR(r) {
  if (r == null) return null;
  if (r < 25) return 72;
  if (r < 50) return 88;
  if (r < 75) return 104;
  return 128;
}

const heartRate = deriveHR(_latest ? _latest.hypertensionRisk : null);

/* Heart Zone Colors */
let zoneLabel = "—";
let zoneColor = "#888";

if (heartRate !== null) {
  if (heartRate < 80) { zoneLabel = "Normal"; zoneColor = "#00e4a8"; }
  else if (heartRate < 95) { zoneLabel = "Elevated"; zoneColor = "#ffe066"; }
  else if (heartRate < 115) { zoneLabel = "High"; zoneColor = "#ff8f3f"; }
  else { zoneLabel = "Dangerous"; zoneColor = "#ff4f4f"; }
}

/* Indicator position (60–140 bpm range) */
function hrPercent(hr) {
  if (hr == null) return 0;
  const v = Math.min(140, Math.max(60, hr));
  return ((v - 60) / 80) * 100;
}
%>

<div class="dashboard-grid">

  <!-- LEFT MAIN VIEW -->
  <section class="hero-card">

    <h2 class="multi-gradient">Heart Overview</h2>

    <div class="tabs">
      <button class="tab active">Heart</button>
      <button class="tab">Eyes</button>
      <button class="tab">Body</button>
      <button class="tab">Brain</button>
    </div>

    <div class="hero-body">

      <!-- HUMAN MODEL -->
      <div class="model-wrap clean-model">
<svg viewBox="0 0 300 520" width="280" xmlns="http://www.w3.org/2000/svg">

  <defs>
    <!-- neon outline -->
    <linearGradient id="outline" x1="0" x2="1">
      <stop offset="0%" stop-color="#9b5cff"/>
      <stop offset="100%" stop-color="#2be0ff"/>
    </linearGradient>

    <!-- soft glow -->
    <filter id="glow">
      <feGaussianBlur stdDeviation="8" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>

    <!-- heart gradient -->
    <radialGradient id="heartFill" cx="40%" cy="30%" r="70%">
      <stop offset="0%" stop-color="#ff8aa3"/>
      <stop offset="70%" stop-color="#ff3b5e"/>
      <stop offset="100%" stop-color="#d1001a"/>
    </radialGradient>
  </defs>

  <!-- BODY OUTLINE (clean, proportionate) -->
  <path
    d="M150 50
       C135 50 125 65 125 80
       V120
       C125 140 110 155 95 165
       L80 175
       C65 185 75 210 90 205
       L110 195
       V320
       C110 350 130 360 150 360
       C170 360 190 350 190 320
       V195
       L210 205
       C225 210 235 185 220 175
       L205 165
       C190 155 175 140 175 120
       V80
       C175 65 165 50 150 50 Z"
    fill="none"
    stroke="url(#outline)"
    stroke-width="3"
    filter="url(#glow)"
    opacity="0.95"
  />

  <!-- HEART AT CHEST (correct position, no translucent background) -->
<!-- HEART AT CHEST — CLEAN VERSION, NO BACKGROUND POSSIBLE -->
<g transform="translate(150,150)">

  <!-- Pure heart shape, no glow, no shadow -->
  <path d="M0 -18
           C10 -30 28 -24 28 -6
           C28 10 14 24 0 36
           C-14 24 -28 10 -28 -6
           C-28 -24 -10 -30 0 -18Z"
        fill="#ff4b68"
        stroke="#ff1e42"
        stroke-width="2">

    <!-- Subtle beating animation -->
    <animateTransform
      attributeName="transform"
      type="scale"
      values="1;1.05;1"
      dur="1s"
      repeatCount="indefinite"
    />
  </path>

</g>



</svg>
</div>





      <!-- RIGHT SIDE STATS -->
      <div class="hero-stats">

        <!-- HEART ZONE CARD -->
        <div class="stat-card">
          <div class="stat-title">Heart Rate Zone</div>

          <div class="stat-value">
            <%= heartRate !== null ? heartRate : "—" %> <span class="small">bpm</span>
          </div>

          <!-- RANGE BAR -->
          <div class="range-container">
            <div class="range-bar">
              <div class="range normal"></div>
              <div class="range elevated"></div>
              <div class="range high"></div>
              <div class="range danger"></div>
            </div>

            <% if (heartRate !== null) { %>
              <div class="range-indicator" style="left:<%= hrPercent(heartRate) %>%">
                <div class="dot" style="background:<%= zoneColor %>"></div>
              </div>
            <% } %>
          </div>

          <div class="stat-footer">
            <span class="badge" style="background:<%= zoneColor %>"><%= zoneLabel %></span>
            <span class="muted">Based on hypertension risk:
              <%= _latest ? _latest.hypertensionRisk + "%" : "—" %></span>
          </div>
        </div>

        <!-- MINI METRICS -->
        <div class="grid-mini">

          <div class="mini">
            <div class="m-title">Diabetic Retinopathy</div>
            <div class="m-value"><%= _latest ? _latest.diabeticRetinopathyLevel : "—" %></div>
          </div>

          <div class="mini">
            <div class="m-title">HbA1c</div>
            <div class="m-value"><%= _latest ? _latest.hba1cLevel : "—" %></div>
          </div>

          <div class="mini">
            <div class="m-title">Atherosclerosis Risk</div>
            <div class="m-value">
              <%= _latest ? Math.round(_latest.atherosclerosisRisk) + "%" : "—" %>
            </div>
          </div>

          <div class="mini">
            <div class="m-title">BMI</div>
            <div class="m-value"><%= _latest ? _latest.BMI : "—" %></div>
          </div>

        </div>

      </div>
    </div>
  </section>

  <!-- RIGHT PANEL CLEANED -->
  <aside class="right-panel">

    <!-- NEW REPORT -->
    <div class="card">
      <div class="card-head">Quick Actions</div>
      <a href="/reports/new" class="btn primary">+ New Report</a>
    </div>

    <!-- LATEST REPORT SNAPSHOT -->
    <div class="card">
      <div class="card-head">Latest Report Summary</div>

      <% if (_latest) { %>
        <div class="report-card">
          <img src="<%= _latest.imageUrl %>" class="report-thumb">
          <div class="report-info">
            <div><strong>DR Level:</strong> <%= _latest.diabeticRetinopathyLevel %></div>
            <div><strong>HbA1c:</strong> <%= _latest.hba1cLevel %></div>
            <div><strong>Hypertension:</strong> <%= _latest.hypertensionRisk %>%</div>
            <div><strong>Created:</strong> <%= new Date(_latest.createdAt).toLocaleString() %></div>
          </div>
        </div>
      <% } else { %>
        <p class="muted">No reports yet.</p>
      <% } %>
    </div>

  </aside>

</div>

<script>
  document.documentElement.classList.add("ui-ready");
</script>
